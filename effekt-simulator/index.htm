<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>

</head>
<body>
<canvas width="500" height="500" id="canvas"></canvas>
<script type="text/javascript" src="lodash.js"></script>
<script type="text/javascript">

	var width = 500
	var height = 500

	var EFFECT_CHARGE = 0x00
	var EFFECT_LOW_BATTERY = 0x01
	var EFFECT_HOLD = 0x02
	var EFFECT_PASS = 0x03
	var EFFECT_IDLE = 0xFE
	var EFFECT_OFF = 0xFF

	var NUM_PIXELS = 24

	var cur_effect = EFFECT_OFF

	var cur_speed = 0.0
	var target_speed = 0.0
	var acceleration = 0.0
	var fade = 0.0
	var start = Date.now()
	var rotation = 0

	var charge = 100
	var last_charge = 0

	var canvas = document.getElementById("canvas")
	var ctx = canvas.getContext('2d')

	var initial = []
	var target = []
	var faded = []
	var rotated = []
	var smoothed = []

	for(var i = 0; i < NUM_PIXELS; i++) {
		initial[i] = {r:0, g:0, b: 0}
		target[i] = {r:0, g:0, b: 0}
		faded[i] = {r:0, g:0, b: 0}
		rotated[i] = {r:0, g:0, b: 0}
		smoothed[i] = {r:0, g:0, b: 0}
	}



	var run = function() {
		//console.log("run")
		setFadingSpeed(1000)
		if(cur_effect == EFFECT_CHARGE && last_charge != charge) {
			setInitial()
			console.log("doing charge")

			setRotationSpeed(0.1)
			last_charge = charge

			for(var i = 0; i < NUM_PIXELS; i++) {
				var p = target[i]
				//p.b = 24.0/(i+1) * (charge+8) * 3.0 - 127
				//p.b = Math.max(Math.min(p.b, 255), 0)
				p.r = 127
				p.g = 127
			}
		}
		calc()
	}

	var setPixel = function(num, R, G, B) {
		var p = target[num]
		p.r = R
		p.g = G
		p.b = B
	}

	var setInitial = function() {
		start = Date.now()
		initial = _.clone(faded, 1)
	}

	var calc = function(timestamp) {
		var dt = Date.now()-start

		var a = Math.max( ( (fade - dt) / fade), 0)
		var b = 1 - a

		rotation = rotation + speed
		//fade
		for(var k = 0; k < NUM_PIXELS; k++) {
			var i = initial[k]
			var t = target[k]
			var f = faded[k]

			//console.log(c)

			f.r = ( (a * i.r) + (b * t.r) )
			f.g = ( (a * i.g) + (b * t.g) )
			f.b = ( (a * i.b) + (b * t.b) )
		}

		//rotate
		for(var m = 0; m < NUM_PIXELS; m++) {
			var f = faded[m]
			var r = rotated[ ( (m+rotation)%NUM_PIXELS)|0 ]

			r.r = f.r
			r.g = f.g
			r.b = f.b
		}

		for(var l = 0; l < NUM_PIXELS; l++) {
			var r1 = rotated[l]
			var r2 = rotated[(l+1)%NUM_PIXELS]
			var s = smoothed[l]

			var perc = rotation - (rotation|0)

			s.r = ( (perc * r1.r) + ( (1-perc) * r2.r ) )|0
			s.g = ( (perc * r1.g) + ( (1-perc) * r2.g ) )|0
			s.b = ( (perc * r1.b) + ( (1-perc) * r2.b ) )|0
		}


		//console.log(a*initial[0].b, b*target[0].b)

	}

	var setEffect = function(effect) {

		cur_effect = effect
	}

	var doTest = function() {
		setFadingSpeed(1000)
		setRotationSpeed(0)
		start = Date.now()

		for(var i = 0; i < NUM_PIXELS; i++) {
			var p = target[i]
			p.b = 0
		}
		target[0].b = 0
		target[1].b = 0
		target[2].b = 0
		target[3].b = 50
		target[4].b = 100
		target[5].b = 150
		target[6].b = 200
	}

	var setRotationSpeed = function(s) {
		speed = s
	}

	var setRotationAcceleration = function(a) {
		acceleration = a
	}

	var setFadingSpeed = function(f) {
		fade = f
	}

	var resetTransform = function(ctx) {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.setTransform(1, 0, 0, 1, 0, 0)
		ctx.translate(250,250)
	}

	var drawCircle = function(ctx, x, y, r, R, G, B) {
		ctx.beginPath()
		ctx.arc(x, y, r, 0, 2*Math.PI, false)
		ctx.fillStyle = "rgb("+R+","+G+","+B+")"
		ctx.fill()
		ctx.closePath()
	}

	var draw = function(timestamp) {
		resetTransform(ctx)
		for(var i = 0; i < NUM_PIXELS; i++) {
			var pixel = smoothed[i]
			drawCircle(ctx, 0, -200, 20, pixel.r, pixel.g, pixel.b)
			ctx.rotate(2*Math.PI / NUM_PIXELS)
		}

	}

	var loop = function(timestamp) {
		run(timestamp)
		draw(timestamp)
		window.requestAnimationFrame(loop)
	}
	setEffect(EFFECT_CHARGE)
	window.requestAnimationFrame(loop)


	</script>
</body>
</html>
